<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Leaderboard – Single Combined Bar (Fixed Buttons)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #0d1b2a; color: #e0e6ed; }
    .container{ max-width:1200px; margin:auto; background:#11243a; padding:20px; border-radius:10px; }
    h2{margin:0 0 12px 0}
    label{font-size:13px;color:#9aa9bf;display:block;margin-bottom:4px}
    input,button{padding:8px;border-radius:6px;border:1px solid #25364a;background:#0f1e30;color:#fff;font-size:14px}
    button{cursor:pointer;margin-right:6px}
    .form-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
    table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{padding:8px;border-bottom:1px solid #223247}
    th{background:#23405a;color:white}
    .badge{padding:6px 10px;border-radius:20px;background:#1b2c44;font-weight:bold}
    .bar-panel{margin-top:24px;background:#0c1a28;padding:18px;border-radius:10px}
    .bar-row{display:flex;align-items:center;margin:10px 0}
    .label{width:160px;font-weight:bold}
    .bar{height:22px;border-radius:4px;background:linear-gradient(90deg,#4cc9f0,#f72585);} /* combined bar */
    .game-item{margin-bottom:6px}
    .edit-btn,.del-btn{padding:4px 8px;font-size:12px;margin-left:6px;border-radius:4px;border:none;color:#0b1220}
    .edit-btn{background:#ffd97d}
    .del-btn{background:#ffb4b4}
    .controls{margin-top:12px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="container">
  <h2>Leaderboard – Single Combined Bar</h2>

  <div class="form-grid">
    <div><label for="teamName">Team</label><input id="teamName"></div>
    <div><label for="gameName">Game</label><input id="gameName"></div>
    <div><label for="gameScore">Score</label><input id="gameScore" type="number"></div>
    <div><label for="timeTaken">Time</label><input id="timeTaken" type="number"></div>
  </div>

  <div class="controls">
    <button id="btnAdd">Add / Update</button>
    <button id="btnCSV">Export CSV</button>
    <button id="btnXLSX">Export Excel (.xlsx)</button>
  </div>

  <table>
    <thead>
      <tr><th>Rank</th><th>Team</th><th>Total Score</th><th>Total Time</th><th>Games</th></tr>
    </thead>
    <tbody id="leaderboardBody"></tbody>
  </table>

  <div class="bar-panel" id="barsPanel">
    <h3>Combined Score & Time Bar</h3>
    <div id="barsContainer"></div>
  </div>
</div>

<script>
// Data model
let teams = {};
const STORAGE_KEY = 'leaderboard_clusterbars_v1_fixed_buttons';

// DOM refs
const teamName = document.getElementById('teamName');
const gameName = document.getElementById('gameName');
const gameScore = document.getElementById('gameScore');
const timeTaken = document.getElementById('timeTaken');
const leaderboardBody = document.getElementById('leaderboardBody');
const barsContainer = document.getElementById('barsContainer');
const btnAdd = document.getElementById('btnAdd');
const btnCSV = document.getElementById('btnCSV');
const btnXLSX = document.getElementById('btnXLSX');

// Events
btnAdd.addEventListener('click', addScore);
btnCSV.addEventListener('click', exportCSV);
btnXLSX.addEventListener('click', exportXLSX);

// Functions
function addScore(){
  const name = teamName.value.trim();
  const game = gameName.value.trim();
  const s = parseInt(gameScore.value, 10);
  const t = parseInt(timeTaken.value, 10);
  if(!name || !game || Number.isNaN(s) || Number.isNaN(t)){
    alert('Please fill all fields correctly');
    return;
  }
  if(!teams[name]) teams[name] = { totalScore:0, totalTime:0, games:[] };
  teams[name].games.push({ game, score: s, time: t });
  teams[name].totalScore += s;
  teams[name].totalTime += t;
  save(); render();
  gameName.value = ''; gameScore.value = ''; timeTaken.value = '';
}

function render(){
  const data = Object.entries(teams).map(([k,v])=>({name:k,...v}))
    .sort((a,b)=> b.totalScore - a.totalScore || a.totalTime - b.totalTime);

  leaderboardBody.innerHTML = '';
  data.forEach((t, i) => {
    const gamesHtml = t.games.map((g, idx) => {
      // use data attributes for safer handling
      return `<div class='game-item' data-team='${escapeHtml(t.name)}' data-index='${idx}'>
        • <b>${escapeHtml(g.game)}</b>: ${g.score} pts, ${g.time} min
        <button class='edit-btn' data-team='${escapeHtml(t.name)}' data-index='${idx}'>Edit</button>
        <button class='del-btn' data-team='${escapeHtml(t.name)}' data-index='${idx}'>Delete</button>
      </div>`;
    }).join('');

    const row = document.createElement('tr');
    row.innerHTML = `
      <td><span class="badge">${i+1} Position</span></td>
      <td>${escapeHtml(t.name)}</td>
      <td>${t.totalScore}</td>
      <td>${t.totalTime}</td>
      <td>${gamesHtml}</td>`;
    leaderboardBody.appendChild(row);
  });

  // attach event handlers for edit/delete (event delegation alternative)
  Array.from(document.getElementsByClassName('edit-btn')).forEach(btn=>{
    btn.removeEventListener('click', onEditClick);
    btn.addEventListener('click', onEditClick);
  });
  Array.from(document.getElementsByClassName('del-btn')).forEach(btn=>{
    btn.removeEventListener('click', onDeleteClick);
    btn.addEventListener('click', onDeleteClick);
  });

  renderBars(data);
}

function onEditClick(e){
  const team = e.currentTarget.getAttribute('data-team');
  const idx = parseInt(e.currentTarget.getAttribute('data-index'), 10);
  editGame(team, idx);
}
function onDeleteClick(e){
  const team = e.currentTarget.getAttribute('data-team');
  const idx = parseInt(e.currentTarget.getAttribute('data-index'), 10);
  deleteGame(team, idx);
}

function editGame(team, i){
  const g = teams[team].games[i];
  const ns = prompt('Score', g.score);
  const nt = prompt('Time', g.time);
  if(ns === null || nt === null) return;
  const nsNum = parseInt(ns, 10); const ntNum = parseInt(nt, 10);
  if(Number.isNaN(nsNum) || Number.isNaN(ntNum)) { alert('Invalid numbers'); return; }
  teams[team].totalScore -= g.score;
  teams[team].totalTime -= g.time;
  g.score = nsNum; g.time = ntNum;
  teams[team].totalScore += g.score;
  teams[team].totalTime += g.time;
  save(); render();
}

function deleteGame(team, i){
  if(!confirm('Delete this game entry?')) return;
  const g = teams[team].games[i];
  teams[team].totalScore -= g.score;
  teams[team].totalTime -= g.time;
  teams[team].games.splice(i,1);
  // if no games left, remove team entirely
  if(teams[team].games.length === 0) delete teams[team];
  save(); render();
}

/* Combined bar = average of normalized score and time */
function renderBars(list){
  barsContainer.innerHTML = '';
  if(list.length === 0) return;
  const maxScore = Math.max(...list.map(t=>t.totalScore), 1);
  const maxTime = Math.max(...list.map(t=>t.totalTime), 1);

  list.forEach(t => {
    const sNorm = t.totalScore / maxScore;
    const tNorm = t.totalTime / maxTime;
    const combined = Math.round(((sNorm + tNorm) / 2) * 70); // percent

    const wrapper = document.createElement('div');
    wrapper.className = 'bar-row';
    wrapper.innerHTML = `<div class='label'>${escapeHtml(t.name)}</div>`;
    const bar = document.createElement('div');
    bar.className = 'bar';
    bar.style.width = combined + '%';
    bar.title = `Score ${t.totalScore}, Time ${t.totalTime}`;
    wrapper.appendChild(bar);
    barsContainer.appendChild(wrapper);
  });
}

// Exports
function exportCSV(){
  let csv = 'Rank,Team,Total Score,Total Time,Game,Score,Time\n';
  const data = Object.entries(teams).map(([k,v])=>({name:k,...v}))
    .sort((a,b)=> b.totalScore - a.totalScore || a.totalTime - b.totalTime);
  data.forEach((t,i)=>{
    if(!t.games || t.games.length === 0) csv += `${i+1},"${t.name}",${t.totalScore},${t.totalTime},,,\n`;
    else t.games.forEach(g=> csv += `${i+1},"${t.name}",${t.totalScore},${t.totalTime},"${g.game}",${g.score},${g.time}\n`);
  });
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'leaderboard.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
}

function exportXLSX(){
  const wb = XLSX.utils.book_new();
  const sheet = [];
  sheet.push(["Rank","Team","Total Score","Total Time","Game","Score","Time"]);
  const data = Object.entries(teams).map(([k,v])=>({name:k,...v}))
    .sort((a,b)=> b.totalScore - a.totalScore || a.totalTime - b.totalTime);
  data.forEach((t,i)=>{
    if(!t.games || t.games.length === 0) sheet.push([i+1,t.name,t.totalScore,t.totalTime,'','', '']);
    else t.games.forEach(g=> sheet.push([i+1,t.name,t.totalScore,t.totalTime,g.game,g.score,g.time]));
  });
  const ws = XLSX.utils.aoa_to_sheet(sheet);
  XLSX.utils.book_append_sheet(wb, ws, 'Leaderboard');
  XLSX.writeFile(wb, 'leaderboard.xlsx');
}

// Persistence
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(teams)); }
function load(){ const d = localStorage.getItem(STORAGE_KEY); if(d) teams = JSON.parse(d); }

// Utilities
function escapeHtml(s){ if(s===undefined||s===null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

// Init
load(); render();
</script>
</body>
</html>
